<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Authors - Book Store</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Reddit+Mono:wght@200..900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="authors.css">
    <!--JQuery-->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <!-- sweet aleret -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <header class="bg-dark text-white py-3">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="logo">
                    <h1 class="h3">Book Store</h1>
                </div>
                <nav>
                    <ul class="nav">
                        <li class="nav-item"><a class="nav-link text-white" href="HTMLPage1.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="#">My Books</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="#">Authors</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="#">Contact</a></li>
                        <li class="nav-item loginBox"><a class="nav-link text-white login">login</a></li>
                        <li class="nav-item userNameBox"><a class="nav-link text-white userName"></a></li>
                        <li class="nav-item logoutBox"><a class="nav-link text-white logout">logout</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    <div class="container booksbyAuthor-body mt-4">
        <label for="authorsDataList" class="form-label pink">Search author: </label>
        <input class="form-control" list="authorsNames" id="authorsNamesInput" placeholder="Type author name to search...">
        <datalist id="authorsNames">
        </datalist>
        <h2 class="text-center text-black">---------------------</h2>
        <div class="author-details"></div>
        <h2 class="text-center text-black authorName"></h2>
        <div id="authors-books" class="row"></div>
    </div>
    <div id="overlay" class=""></div>
    <div id="loader-wrapper"><div id="loader"></div></div>
    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    <!-- JQuary -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
            crossorigin="anonymous"></script>

    <script>
        var usersAPI = "https://localhost:7225/api/IUsers";
        var booksAPI = "https://localhost:7225/api/Books";
        var authorsAPI = "https://localhost:7225/api/Authors";
        var allAuthors = '';

        $(document).ready(function () {

            checkForLoginUser();

            showAuthors();

            $('.logout').click(logoutUser);

        });
        // search author by name
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('authorsNamesInput');
            var selectedAuthor = "";

            searchInput.addEventListener('input', () => {
                const selectedValue = searchInput.value;
                allAuthors.forEach(author => {
                    if (author.name === selectedValue) {
                        selectedAuthor = author;
                    }
                });
                if (selectedAuthor == "") { $(".author-details").html(''); } // If no author name was selected 
                else {
                    showSearchedAuthor(selectedAuthor);
                    loadAthourBooks(selectedAuthor.id);
                    selectedAuthor = "";
                }
            });
        });
        //---------------
        function showSearchedAuthor(author) {
            var html = "";
            html += `
                        <div class='card'>
                            <div class='card-body'>
                                <h4 class='card-text'>${author.name}</h4>`;
            if (author.dateOfBirth == undefined || author.dateOfBirth == "") { }
            else {
                html += `<p class='card-text'>Born: ${author.dateOfBirth}</p>`
            }
            if (author.dateOfDeath == undefined || author.dateOfDeath == "") { }
            else {
                html += `<p class='card-text'>Died: ${author.dateOfDeath}</p>`
            }       
            if (author.age == undefined || author.age == "") { }
            else {
                html += `<p class='card-text'>Age: ${author.age}</p>`
            }  
            if (author.nationality == undefined || author.nationality == "") { }
            else {
                html += `<p class='card-text'>Nationality: ${author.nationality}</p>`
            } 
            if (author.notableWork == undefined || author.notableWork == "") { }
            else {
                html += `<p class='card-text'>Notable Work: ${author.notableWork}</p>`
            } 
            if (author.awards == undefined || author.awards == "") { }
            else {
                html += `<p class='card-text'>Awards: ${author.awards}</p>`
            } 
            if (author.description == undefined || author.description == "") { }
            else {
                html += `<p class='card-text'>Description: ${author.description}</p>`
            } 
            html += `  <h4 class='authorBooksTitle'></h4>  <div class="row authour-books"></div> </div>
                        </div>`;
            $(".author-details").html(html)
        }
        // load all the books by author
        function loadAthourBooks(selectedAuthor) {
 
            ajaxCall("GET", authorsAPI + `/findBookByAuthor/?authorId=${selectedAuthor}`, null, successToLoadBooks, errorToLoadAuthors)
        }

        function successToLoadBooks(authorBooks) {
            var html = "";
            const rating = stars => '★★★★★☆☆☆☆☆'.slice(5 - stars, 10 - stars);

            document.querySelector(".authorBooksTitle").innerHTML += 'Books By ' + authorBooks[0].FirstAuthorName + ':';

            authorBooks.forEach((book) => {
                
                html += `
                    <div class='col-md-3'>
                        <div class='card mb-4 book-card'>
                            <img src='${book.SmallThumbnail}' class='card-img-top' alt='Book'>
                            <div class='card-body w-100'>
                                <h6 class='card-title'>${book.Title}</h6>
                                <p id='pinkStars'>${rating(book.Rating)}  ${(book.Rating).toFixed(1)}</p>
                                <span class='card-text'>${book.Price}$</span></div></div></div>`;
            })
            $(".authour-books").html(html);
        }

        function showAuthors() {
            if (allAuthors.length == 0) {
                ajaxCall("GET", authorsAPI, null, authorsToShow, errorToLoadAuthors);
            } else {
                authorsToShow(allAuthors);
            }
        }

        function errorToLoadAuthors(err) {
            console.log(err);
        }

        function authorsToShow(authors) {
            var authorNameSearchBar = "";

            allAuthors = authors;

            allAuthors.forEach((author) => { authorNameSearchBar += `<option value='${author.name}'>` })

            $("#authorsNames").html(authorNameSearchBar);
        }

        function ajaxCall(method, api, data, successCB, errorCB) {
            $.ajax({
                type: method,
                url: api,
                data: data,
                cache: false,
                contentType: "application/json",
                dataType: "json",
                success: successCB,
                error: errorCB
            });
        }
        function checkForLoginUser() {
            var loginUser = JSON.parse(localStorage.getItem("loginUserDetails"))

            if (loginUser != null) {
                $('.userNameBox').show();
                $('.logoutBox').show();
                $('.loginBox').hide();
                $('.userName').text(loginUser.userName);
                $('.myBooks').show();
            }
            else {
                $('.userNameBox').hide();
                $('.logoutBox').hide();
                $('.loginBox').show();
                $('.userName').text("");
                $('.myBooks').hide();
            }
        }

        function logoutUser() {
            let user = JSON.parse(localStorage.getItem("loginUserDetails"));
            if (user) {
                let userIdToLogout = user.userId;
                ajaxCall("PUT", `${usersAPI}/logoutUser`, JSON.stringify(userIdToLogout), successLogout, errorLogout);
            }
        }

        function successLogout(status) {
            if (status) {

                localStorage.clear();

                window.location.href = "HTMLPage1.html";
            }
        }

        function errorLogout(errorMessage) {
            console.log(errorMessage);
            Swal.fire('Error', 'Failed to logout. Please try again.', 'error');
        }

    </script>
</body>
</html>
