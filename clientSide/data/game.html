<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Game</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <!-- JQuary -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <!-- boot strap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- sweet alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .Memorybody {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #121212;
            margin: 0;
        }

        .game-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 150px); /* Increase card size */
            grid-gap: 15px; /* Adjust spacing */
        }

        .card {
            width: 150px; /* Increase card size */
            height: 150px; /* Increase card size */
            background-color: #ff0083;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d; /* Ensure 3D transforms work */
            transform: rotateY(0deg); /* Start with the back side visible */
            transition: transform 0.5s;
        }

            .card.flip {
                transform: rotateY(180deg); /* Show the front side when flipped */
            }

        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            border-radius: 8px;
            background-color: #ff0083;
        }

        .card-front {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white; /* Ensure text is visible */
            border-radius: 8px;
            background-color: #ff0083; /* Default background color */
            background-size: cover;
            background-position: center;
            transform: rotateY(180deg); /* Hide the front side when card is not flipped */
        }

        .stats {
            margin-bottom: 20px;
         
        }
        .card.correct {
            background-color: #ff0083; /* צבע רקע כאשר הכרטיסים מתאימים */
            pointer-events: none; /* מונע לחיצה נוספת על הכרטיס */
        }
        #start-game-btn {
            background-color: #ff0083;
        }
    </style>
</head>
<body>
    <div class="Memorybody">
        <div class="game-container">
            <div class="stats">
                <button id="start-game-btn">Start Game</button>
                <p>Attempts: <span id="attempts">0</span></p>
                <p>Time: <span id="time">0</span> seconds</p>
            </div>
            <div id="game-board" class="game-board"></div>
        </div>
    </div>

    <script>
        var booksAPI = "https://localhost:7225/api/Books";
        var allBooks = [];
        let victoryTime = null;
        let victoryAttempts = null;
        let gameCards = [];
        let firstCard = null;
        let secondCard = null;
        let lockBoard = false;
        let attempts = 0;
        let matches = 0;
        let timer = null;
        let time = 0;

        document.getElementById('start-game-btn').addEventListener('click', showBooks);

        function ajaxCall(method, api, data, successCB, errorCB) {
            $.ajax({
                type: method,
                url: api,
                data: data,
                cache: false,
                contentType: "application/json",
                dataType: "json",
                success: successCB,
                error: errorCB
            });
        }

        function showBooks() {
            if (allBooks.length == 0) {
                ajaxCall("GET", booksAPI, null, getAllBooks, errorToLoadBooks);
            } else {
                startGame();
            }
        }

        function getAllBooks(books) {
            allBooks = books;
            startGame();
        }

        function errorToLoadBooks() {
            console.error("The books could not be loaded.");
        }

        function startGame() {
            resetGame();
            createMemoryCards();
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';
            gameCards.forEach((card) => {
                const cardElement = createCardElement(card);
                gameBoard.appendChild(cardElement);
            });
            startTimer();
        }

        function createMemoryCards() {
            const selectedBooks = allBooks.sort(() => Math.random() - 0.5).slice(0,4);
            gameCards = [];
            selectedBooks.forEach(book => {
                // Add cover card
                gameCards.push({ ...book, type: 'cover' });
                // Add author card
                gameCards.push({ ...book, type: 'author' });
            });
            gameCards.sort(() => Math.random() - 0.5);
        }

        function createCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.classList.add('card');
            cardElement.dataset.name = card.Title;
            cardElement.dataset.type = card.type;
            cardElement.dataset.AuthorName = card.FirstAuthorName;

            const cardFront = document.createElement('div');
            cardFront.classList.add('card-front');

            // Set the front side content
            if (card.type === 'cover') {
                cardFront.style.backgroundImage = `url(${card.SmallThumbnail})`;
                cardFront.style.backgroundSize = 'cover';
            } else if (card.type === 'author') {
                cardFront.style.backgroundColor = '#e6e6e6';
                cardFront.style.color = '#333';
                cardFront.style.display = 'flex';
                cardFront.style.justifyContent = 'center';
                cardFront.style.alignItems = 'center';
                cardFront.style.fontSize = '16px';
                cardFront.innerText = card.FirstAuthorName || "Unknown Author";
            }

            const cardBack = document.createElement('div');
            cardBack.classList.add('card-back');

            cardElement.appendChild(cardFront);
            cardElement.appendChild(cardBack);

            cardElement.addEventListener('click', flipCard);
            return cardElement;
        }
        

        function flipCard() {
            if (lockBoard || this.classList.contains('flip') || (firstCard && secondCard)) return;

            this.classList.add('flip');

            if (!firstCard) {
                firstCard = this;
                console.log('First card set:', firstCard);
                return;
            }

            secondCard = this;
            console.log('Second card set:', secondCard);

            checkForMatch();
        }

        function checkForMatch() {
            if (!firstCard || !secondCard) {
                console.error("One or both cards are missing!", { firstCard, secondCard });
                resetBoard();
                return;
            }

            console.log('Checking match for:', firstCard.dataset.name, secondCard.dataset.name);

            const isMatch = firstCard.dataset.AuthorName === secondCard.dataset.AuthorName;

            if (isMatch) {
                disableCards();
                if (firstCard) {
                    console.log('Adding correct class to first card');
                    firstCard.classList.add('correct');
                }
                if (secondCard) {
                    console.log('Adding correct class to second card');
                    secondCard.classList.add('correct');
                }
                // Display message for correct match
                Swal.fire({
                    icon: 'success',
                    title: 'Good',
                    text: 'you find a match!',
                    timer: 1000,
                    showConfirmButton: false
                });
            } else {
                unflipCards();
            }

            attempts++;
            document.getElementById('attempts').textContent = attempts;

            if (matches === gameCards.length / 2) {
                victoryTime = time;
                victoryAttempts = attempts
                setTimeout(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'You Win!',
                        text: `Attempts: ${victoryAttempts}, Time: ${victoryTime} seconds`,
                        confirmButtonText: 'New Game',
                        showCancelButton: true,
                        cancelButtonText: 'Cancel'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            resetGame();
                        }
                    });
                    clearInterval(timer);
                }, 500);

            }
        }

        function disableCards() {
            if (firstCard && secondCard) {
                firstCard.removeEventListener('click', flipCard);
                secondCard.removeEventListener('click', flipCard);
                matches++;
                resetBoard();
            }
        }

        function unflipCards() {
            if (firstCard && secondCard) {
                lockBoard = true;
                setTimeout(() => {
                    if (firstCard && secondCard) {
                        firstCard.classList.remove('flip');
                        secondCard.classList.remove('flip');
                    }
                    resetBoard();
                }, 1500);
            }
        }

        function resetBoard() {
            [firstCard, secondCard, lockBoard] = [null, null, false];
        }

        function startTimer() {
            time = 0;
            document.getElementById('time').textContent = time;
            timer = setInterval(() => {
                time++;
                document.getElementById('time').textContent = time;
            }, 1000);
        }


        function resetGame() {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';
            firstCard = secondCard = null;
            lockBoard = false;
            attempts = matches = time = 0;
            document.getElementById('attempts').textContent = attempts;
            document.getElementById('time').textContent = time;
            clearInterval(timer);
        }
     
    </script>
</body>
</html>
