<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Store</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!--<link rel="stylesheet" href="styles.css">-->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>
    <script src="sharedFunc.js"></script>
    <style>
        .pinkB {
            background-color: #ff0083;
        }

        .add-image-btn {
            background-color: #ff0083;
            margin-bottom: 10px;
        }

        .card-body, club-card {
            font-size: 15px;
            color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .uploaded-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        .loading-spinner {
            display: none;
            margin-top: 10px;
        }

        #result-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }



        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        #form-modal {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #2c2c2c;
            color: #fff;
        }

        .club-card {
            height: 350px;
            width: 250px;
            align-items: center;
            background-color: #2c2c2c;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        #club-info-container {
            position: fixed;
            background-color: #2c2c2c;
            color: black;
            text-align: center;
            height: 550px;
            width: 500px;
            max-height: 80%;
            max-width: 50%;
            top: 55%;
            left: 50%;
            padding: 1%;
            transform: translate(-50%, -50%);
            transition: 200ms ease-in-out;
            border: 1px solid #ff0083;
            border-radius: 5px;
            display: none;
            z-index: 2;
            overflow: auto;
        }

        .club-info {
            background-color: #2c2c2c;
            color: white;
        }

        .add-image-btn {
            background-color: #ff0083;
            margin-bottom: 10px;
        }

        .card-body, book-card {
            font-size: 15px;
            color: black;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .uploaded-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        .loading-spinner {
            display: none;
            margin-top: 10px;
        }

        #result-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }



        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        #form-modal {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: rgba(0, 0, 0, .125);
            color: #fff;
        }

        .form-group {
            align-content: center;
        }
        /*        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1001;
        }*/

        /*       .modal-content {
            background-color: #2c2c2c;
            color: #fff;
            padding: 20px;
            border-radius: 5px;
            width: 50%;
        }*/
        .modal-content {
            width: 50%;
            top: 25%;
            right: 25%;
            left: 25%;
            color: black;
            display: flex;
            background-color: #2c2c2c;
            color: #fff;
            background-clip: border-box;
            border: 1px solid rgba(0, 0, 0, .125);
            border-radius: .25rem;
        }

        #club-info-container.active {
            display: block;
            transform: translate(-50%, -50%) scale(1);
        }
    </style>

</head>
<body>
    <header class="bg-dark text-white py-2 fixed-top">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark sticky-top">

                <a class="navbar-brand" id="nav-title">Book Store</a>

                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbar">
                    <ul class="navbar-nav ml-auto">
                        <li class="nav-item"><a class="nav-link text-white" href="HTMLPage1.html">Home</a></li>
                        <li class="nav-item adminPage"><a class="nav-link text-white " href="adminPage.html">Admin Page</a></li>
                        <li class="nav-item myBooks"><a class="nav-link text-white " href="#">My Books</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="author.html">Authors</a></li>
                        <li class="nav-item"><a class="nav-link text-white" href="TheGoodBookClub.html">Books Clubs</a></li>
                        <li class="nav-item games"><a class="nav-link text-white games" href="games.html">games</a></li>
                        <li class="nav-item loginBox"><a class="nav-link text-white login">login</a></li>
                        <li class="nav-item userNameBox">
                            <a class="nav-link text-white userName"></a>
                        </li>
                        <li class="nav-item logoutBox"><a class="nav-link pink whiteHover logout" style="color: #ff0083">logout</a></li>
                        <li class="nav-item dropdown requestBox">
                            <button class="btn btn-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span id="message-count" class="badge">0</span> <!-- Badge -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                                    <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z" />
                                </svg>
                            </button>
                            <div class="dropdown-menu dropdown-menu-dark dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                <div class="send"> </div>
                                <div class="got"> </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
    </header>




    <section class="hero text-center py-5">
        <div class="container">
            <h2 class="display-4">My Clubs</h2>
            <nav class="navbar navbar-dark bg-dark justify-content-between search-books-bar">
                <span class="left-pan">
                    <a class="navbar-brand pink">Search Clubs</a>
                    <svg class="speech-to-text" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
                        <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5" />
                        <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3" />
                    </svg>
                </span>
                <form class="form-inline">
                    <input class="form-control mr-sm-2 search-string" list="clubSearch" type="search" placeholder="Search By Book Title" aria-label="Search">
                    <datalist id="clubSearch"></datalist>
                    <button id="search-club-btn" class="btn btn-outline-dark my-2 my-sm-0 pinkB " type="button"> Search</button>
                </form>
                <div class="nav-item dropdown requestBox">
                    <button class="btn btn-outline-dark my-2 my-sm-0 pinkB" onclick="createNewClub()" type="button">
                        Create new book club
                    </button><!-- Overlay -->
                    <div id="overlay" class="overlay"></div>

                    <!-- Form Modal -->
                    <div id="form-modal" class="modal">
                        <div class="modal-content">
                            <span class="close-btn" onclick="closeForm()">&times;</span>
                            <h2>Create New Book Club</h2>
                            <form id="create-club-form">
                                <div class="form-group">
                                    <label for="club-title">Book Title:</label>
                                    <select id="club-title" class="form-control">
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-light pinkB">Create Club</button>
                            </form>
                        </div>
                    </div>
                    <div id="overlay" class="overlay"></div>

                    <div id="create" class="dropdown-menu dropdown-menu-dark"></div>
                </div>
            </nav>
            <div id="container-clubs" class="row"></div>
        </div>
    </section>




    <!-- book club info -->
    <div id="overlay" class="overlay"></div>

    <div id="club-info-container">
        <div class="club-info-header">
            <button data-close-button class="close-button closeBookInfoButton" onclick="closeclubInfo()">&times;</button>
            <button type="button" class="btn btn-light pinkB" id="join-club" onclick="joinClub()">Join club</button>
            <br />
            <div class='card-body'>
                <img class="club-image-info" />
                <h1 class="club-info-title"></h1>
                <div class="club-members"></div>
                <input type='file' class='form-control-file image-input' style='display:none;'>
                <div class='image-preview'></div>

                <div class="add-post-to-club">
                    <button class='btn add-image-btn'>Add Image</button>
                    <input type="text" class="text-input form-control" placeholder="Enter description here...">
                    <button class='btn btn-light generate-btn' type="button">Generate Image</button>
                    <img class="result-img img-fluid" style="display:none;" alt="Generated Image">
                    <div class="comment">
                        <label for="comment" class="pink">Tell us more:</label><br>
                        <textarea id="comment" name="comment" oninput="updateCharacterCount()" maxlength="255"></textarea>
                        <p id="charCount">0/255 characters</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <section class="books py-5">
        <div class="container">
            <div class="row" id="myBooks"></div>
        </div>
    </section>

    <footer class="bg-dark text-white py-3">
        <div class="container text-center">
            <p>All rights reserved © 2024 Book Store</p>
        </div>
    </footer>

    <script>

        $(document).ready(function () {
            checkForLoginUser();
            showBooks();
            getClubs();
            $('#search-club-btn').click(searchClub);
        });

        var booksAPI = "https://localhost:7225/api/Books";
        var clubBooksAPI = "https://localhost:7225/api/BookClub";
        var uploadFilesAPI = 'https://localhost:7225/api/upload';
        var usersAPI = "https://localhost:7225/api/IUsers";
        var allBooks = [];
        var allClubs = [];
        let booksDict = [];
        let clubsDict = [];
        let currentClub;

        function searchClub() {
            let searchstring = $('.search-string').val();
            console.log(searchstring);
            let searchClub = [];
            allClubs.forEach((club) => {
                if (club.ClubName == searchstring) {
                    searchClub.push(club);
                }
            })
            console.log(searchClub);
            const clubsContainer = document.getElementById("container-clubs");
            let clubsHtml = '';
            if (!clubsContainer) {
                console.error("Container for clubs not found.");
                return;
            }

            searchClub.forEach(club => {
                clubsHtml += `
                            <a id='club-info' onclick=showclubInfo(${club.ClubId}) >
                                <div class='col-md-3 club-info'>
                                    <div class='card mb-4 club-card'>
                                            <h6 class='card-title'>${club.ClubName}</h6>
                                            <img src='${club.ClubImage}'>
                                            <br/>
                                            <button type="submit" class="btn btn-light pinkB">Add post</button>
                                    </div>
                                </div></a>`
                    ;
            });
            clubsContainer.innerHTML = clubsHtml;
        }
        // Function to initialize clubsDict
        function activateSearchBooksBar() {
            allClubs.forEach((club) => {
                let text = club.Title;
                clubsDict[JSON.stringify(club)] = text;
            });
        }


        function createNewClub() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('form-modal').style.display = 'block';

            const clubTitleSelect = document.getElementById('club-title');//make dropdown with book titles
            clubTitleSelect.innerHTML = '';//clear previous select
            booksDict.forEach(bookTitle => {
                const option = document.createElement('option');
                option.value = bookTitle;
                option.textContent = bookTitle;
                clubTitleSelect.appendChild(option);
            });
            document.getElementById('create-club-form').onsubmit =
                async function (event) {
                    event.preventDefault(); //prevent from the browser to do the default action, like in this case to load the browser again
                    let selectedTitle = clubTitleSelect.value;

                    var userId = JSON.parse(localStorage.getItem("loginUserDetails"))

                    if (userId != null) {

                        userId = userId.userId; // set the user id from the json
                    }

                    console.log(userId);
                    await ajaxCall("POST", clubBooksAPI + `/creatClub?clubName=${selectedTitle}&userId=${userId}`, JSON.stringify({ ClubName: selectedTitle, userId: userId }), successCreateBookClub, errorCreateBookClub);
                    closeForm();
                    ajaxCall("GET", clubBooksAPI + "/getAllClubs", null, showAllClubs, errorR);


                }
        }
        function closeForm() {
            console.log("Closing form");
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('form-modal').style.display = 'none';
        }

        function successCreateBookClub() {
            console.log("success Create Book Club");
        }
        function errorCreateBookClub(err) {
            console.log(err)
        }
        function errorR(err) {
            console.log(err);
        }

        function getClubs() {
            if (allClubs.length == 0) {
                ajaxCall("GET", clubBooksAPI + "/getAllClubs", null, showAllClubs, errorR);

            }
            else {
                showAllClubs(allClubs);
            }
        }
        function successjoinClub() {
            Swal.fire("success join club");
            showclubInfo(currentClub.ClubId);
        }

        function joinClub() {

            var userId = JSON.parse(localStorage.getItem("loginUserDetails"))

            if (userId != null) {

                userId = userId.userId; // set the user id from the json
                ajaxCall("POST", clubBooksAPI + `/joinClub?clubId=${currentClub.ClubId}&userId=${userId}`, null, successjoinClub, errorR);
            }

        }
        function showAllClubs(response) {
            allClubs = response;
            const clubsContainer = document.getElementById("container-clubs");
            let clubsHtml = '';

            if (!clubsContainer) {
                console.error("Container for clubs not found.");
                return;
            }

            allClubs.forEach(club => {
                clubsHtml += `
                            <a id='club-info' onclick=showclubInfo(${club.ClubId}) >
                                <div class='col-md-3 club-info'>
                                    <div class='card mb-4 club-card'>
                                            <h6 class='card-title'>${club.ClubName}</h6>
                                            <img src='${club.ClubImage}'>
                                            <br/>
                                    </div>
                                </div></a>`
                    ;
            });
            clubsContainer.innerHTML = clubsHtml;
            setupGenerateButtons(); //
            document.querySelectorAll('.add-image-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const cardBody = this.closest('.card-body');
                    const fileInput = cardBody.querySelector('.image-input');

                    // Trigger the file selection
                    fileInput.click();

                    fileInput.addEventListener('change', function () {
                        const formData = new FormData();
                        const files = fileInput.files;

                        // Add the uploaded file to the form data collection
                        if (files.length > 0) {
                            for (let f = 0; f < files.length; f++) {
                                formData.append("files", files[f]);
                            }

                            // Perform AJAX request to upload the image
                            ajaxCall("POST", uploadFilesAPI, formData, showImages(formData, cardBody), errorToLoadImage);
                        }
                    });
                });
            });
            var clubNameSearchBar = "";
            allClubs.forEach((club) => {
                clubNameSearchBar += `<option value='${club.ClubName}'>`
            })
            $("#clubSearch").html(clubNameSearchBar);
        }

        function showImages(response, cardBody) {
            console.log("Image uploaded successfully:", response);

            const imagePreviewContainer = cardBody.querySelector('.image-preview');

            // Create and append new images
            response.forEach(image => {
                const imgElement = document.createElement('img');
                imgElement.src = `https://localhost:7225/uploadedFiles/${image}`; // Adjust path as needed
                imgElement.alt = "Uploaded Image";
                imgElement.className = "uploaded-image img-fluid mt-2";
                imagePreviewContainer.appendChild(imgElement);
            });
        }

        function errorToLoadImage(err) {
            console.error("Error uploading image:", err);
        }

        function ajaxCall(method, url, data, successCallback, errorCallback) {
            $.ajax({
                type: method,
                url: url,
                data: data,
                processData: false,  // Important for file uploads
                contentType: false,  // Important for file uploads
                success: successCallback,
                error: errorCallback
            });
        }

        function showBooks() {
            if (allBooks.length == 0) {
                ajaxCall("GET", booksAPI, null, showAllBooks, errorToLoadBooks);
            }
            else { showAllBooks(allBooks); }
        }

        function showAllBooks(response) {
            allBooks = response;
            activateSearchBooksBar();
            populateDropdown(booksDict);
        }

        function errorToLoadBooks() {
            console.log("Error loading books");
        }

        function activateSearchBooksBar() {
            allBooks.forEach((book) => {
                let text = book.Title;
                booksDict.push(text);
            });
            console.log(booksDict);
        }

        function populateDropdown(items) {
            var dropdownMenu = document.getElementById('create');
            dropdownMenu.innerHTML = '';
            items.forEach(item => {
                var listItem = document.createElement('a');
                listItem.className = 'dropdown-item';
                listItem.href = '#';
                listItem.textContent = item;

                listItem.addEventListener('click', function () {
                    document.querySelector('.text-input').value = item;  // Make sure this element exists
                });

                dropdownMenu.appendChild(listItem);
            });
        }

        // Text to Image
        async function queryTEXTtoIMG(text) {
            const response = await fetch(
                "https://api-inference.huggingface.co/models/CompVis/stable-diffusion-v1-4",
                {
                    headers: { Authorization: "Bearer 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" },
                    method: "POST",
                    body: JSON.stringify({ inputs: text }),
                }
            );
            if (!response.ok) {
                throw new Error("Image generation failed. Please try again.");
            }
            return response.blob();
        }

        async function TextToImage(cardBody) {
            const textInput = cardBody.querySelector(".text-input").value.trim(); // עדכון לקרוא את שדה התיאור מהכרטיס
            const resultImg = cardBody.querySelector(".result-img"); // עדכון לקרוא את תמונת התוצאה מהכרטיס

            console.log("Text input value:", textInput); // Debugging line

            if (!textInput) {
                alert("Please enter a description.");
                return;
            }

            if (!resultImg) {
                console.error("Result image element not found.");
                return;
            }

            try {
                const imageBlob = await queryTEXTtoIMG(textInput);
                const imageUrl = URL.createObjectURL(imageBlob);
                resultImg.src = imageUrl;
                resultImg.style.display = "block";
            } catch (error) {
                alert(error.message);
            }
        }

        // השתמש בפונקציה הזו כדי להוסיף מאזינים לכפתורים
        function setupGenerateButtons() {
            document.querySelectorAll('.generate-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const cardBody = this.closest('.card-body');
                    TextToImage(cardBody); // קרא לפונקציה עם כרטיס ספציפי
                });
            });
        }
        //function that show club extra information
        function closeclubInfo() {
            $('#club-info-container').removeClass('active');
            $('#overlay').removeClass('active');
        }
        
        function showclubInfo(clubId) {

            $("#join-club").show();

            ajaxCall("GET", clubBooksAPI + `/getAllClubMembers?clubId=${clubId}`, null, seccessToshowclubMembers, errorToshowclubMembers)

            allClubs.forEach((club) => {
                if (club.ClubId == clubId) {
                    currentClub = club;
                }
            })

            console.log(currentClub);
            $('#club-info-container').addClass('active');
            $('#overlay').addClass('active');
            $('.club-info-title').html(currentClub.ClubName);
            $('.club-image-info').attr("src",currentClub.ClubImage);
        }

        function errorToshowclubMembers(err) {
            console.log(err);
        }
        function seccessToshowclubMembers(members) {
            let currentUserId = JSON.parse(localStorage.getItem("loginUserDetails")).userId
            let html = "";

            members.forEach((member) => {
                html += `<p>${member.userName}</p>`

                if (currentUserId == member.userId) { $("#join-club").hide(); }
            })

            $(".club-members").html(html);
        }
        function postReviewClub() {
            if (document.querySelector('input[name="rating"]:checked') == null) { }
            else {
                bookRating = document.querySelector('input[name="rating"]:checked').value;
            }
            var comment = document.getElementById("comment").value;
            let userId = JSON.parse(localStorage.getItem("loginUserDetails")).userId;


            ajaxCall("PUT", booksAPI + `/RateBook?bookID=${bookIdToRate}&newRating=${bookRating}&userID=${userId}&review=${comment}`, null, successRating, errorRating);

            return false;
        }
        ///
        function showBooks() { };
        function showMyBooks() { };
        function closeBookInfo() { };

        function updateCharacterCount() {
            const textInput = document.getElementById('comment');
            const charCount = document.getElementById('charCount');
            const currentLength = textInput.value.length;

            charCount.textContent = `${currentLength}/255 characters`;
        }
    </script>


</body>
</html>
