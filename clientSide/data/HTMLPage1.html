<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <svg class="bubble-head-left-s " viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <path fill="#FF0066" d="M42.5,-69C54.3,-66.7,62.8,-53.9,71.7,-40.7C80.7,-27.4,90.1,-13.7,80.6,-5.5C71.1,2.7,42.6,5.5,29.9,12.2C17.2,18.9,20.2,29.5,17.8,42.6C15.5,55.6,7.7,71.1,-3.3,76.8C-14.4,82.6,-28.8,78.7,-41.7,71.7C-54.5,64.8,-65.9,54.7,-70.4,42.2C-74.9,29.7,-72.5,14.9,-72.1,0.3C-71.7,-14.3,-73.1,-28.7,-67,-38.3C-60.8,-48,-47.1,-52.9,-34.7,-55C-22.3,-57,-11.1,-56.1,2.1,-59.6C15.3,-63.2,30.6,-71.3,42.5,-69Z" transform="translate(100 100)" />
    </svg>
    <svg class="bubble-head-left bubble-head" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <path fill="#FF0066" d="M42,-71.1C53,-66.4,59.4,-52.2,63.5,-38.8C67.6,-25.4,69.4,-12.7,72.2,1.7C75.1,16,79.1,32,72.8,41.6C66.5,51.3,50,54.6,36.1,61.2C22.3,67.7,11.2,77.5,-2.3,81.5C-15.7,85.4,-31.4,83.5,-45.2,76.9C-58.9,70.3,-70.8,59,-77.8,45.4C-84.8,31.8,-86.9,15.9,-83.3,2.1C-79.6,-11.7,-70.2,-23.4,-61.4,-33.9C-52.6,-44.3,-44.4,-53.5,-34.3,-58.8C-24.2,-64,-12.1,-65.3,1.7,-68.3C15.5,-71.2,31,-75.9,42,-71.1Z" transform="translate(100 100)" />
    </svg>
    <svg class="bubble-head-right  bubble-head" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <path fill="#FF0066" d="M34.6,-60.8C47.9,-52.2,63.8,-49.1,72.8,-39.9C81.9,-30.7,84.1,-15.3,80.9,-1.9C77.6,11.6,68.9,23.2,62.3,36.7C55.8,50.3,51.3,65.8,41.3,74.9C31.3,84.1,15.6,87,2.1,83.3C-11.3,79.6,-22.7,69.3,-36.5,62.2C-50.3,55.2,-66.5,51.5,-72.8,41.7C-79,31.8,-75.4,15.9,-74.8,0.4C-74.2,-15.2,-76.6,-30.4,-71.8,-42.9C-67.1,-55.4,-55.2,-65.1,-42,-73.8C-28.8,-82.4,-14.4,-89.8,-1.9,-86.6C10.7,-83.3,21.3,-69.3,34.6,-60.8Z" transform="translate(100 100)" />
    </svg>
    <title>Book Store</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">

    <!-- JQuary -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
            crossorigin="anonymous"></script>
    <!-- boot strap -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <!-- sweet aleret -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.0/dist/browser/signalr.min.js"></script>


</head>
<body>
    <header class="bg-dark text-white py-2 fixed-top">
        <div class="container">
                <nav class="navbar navbar-expand-lg navbar-dark sticky-top">

                    <a class="navbar-brand" id="nav-title">Book Store</a>

                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navbar">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item"><a class="nav-link text-white" href="#">Home</a></li>
                            <li class="nav-item adminPage"><a class="nav-link text-white " href="adminPage.html">Admin Page</a></li>
                            <li class="nav-item myBooks"><a class="nav-link text-white " href="myBooks.html">My Books</a></li>
                            <li class="nav-item"><a class="nav-link text-white" href="author.html">Authors</a></li>
                            <li class="nav-item bookClubPage"><a class="nav-link text-white" href="TheGoodBookClub.html">Books Clubs</a></li>
                            <li class="nav-item games"><a class="nav-link text-white games" href="games.html">games</a></li>
                            <li class="nav-item loginBox"><a class="nav-link text-white login">login</a></li>
                            <li class="nav-item userNameBox">
                                <a class="nav-link text-white userName"></a>
                            </li>
                            <li class="nav-item logoutBox"><a class="nav-link pink whiteHover logout" style="color: #ff0083">logout</a></li>
                            <li class="nav-item dropdown requestBox">
                                <button class="btn btn-dark dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span id="message-count" class="badge">0</span> <!-- Badge -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                                        <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z" />
                                    </svg>
                                </button>
                                <div class="dropdown-menu dropdown-menu-dark dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                                    <div class="send"> </div>
                                    <div class="got"> </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </nav>
        </div>
    </header>

    <section class="hero text-center py-5">
        <div class="container">
            <h2 class="display-4">Welcome to Our Book Store</h2>
            <p class="lead">Discover the largest selection of books</p>
            <a class="btn btn-outline-dark btn-lg pinkB" id="show-quiz">Book Quiz</a>
        </div>
    </section>

    <!-- top 5 courses by rating  -->
    <section class="books py-5">
        <div class="container">
            <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner top-5-books" id="top5Books">

                </div>
                <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>
    </section>
    <section class="books py-5">
        <div class="container">
            <h2 class="text-center text-white mb-5">Recommended Books</h2>
            <nav class="navbar navbar-dark bg-dark justify-content-between search-books-bar">
                <a class="navbar-brand pink search-bar-title">Search Books</a>
                <div class="search-div d-flex justify-content-center align-items-center">

                        <div class="form">
                            <i class="fa fa-search"></i>
                            <input type="text" class="form-control form-input search-string" placeholder="Search Books...">
                            <span class="left-pan">
                                <svg class="speech-to-text" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-mic" viewBox="0 0 16 16">
                                    <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5" />
                                    <path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3" />
                                </svg>
                            </span>
                        </div>

                    <button class="btn btn-outline-dark my-2 my-sm-0 pinkB search-book-btn" type="submit">Search</button>
                    <button class="btn btn-outline-dark my-2 my-sm-0 pinkB reset-search-book" type="submit">Reset</button>
                </div>

            </nav>
            <div class="container">
            <div class="row" id="allBooks">

            </div>
        </div>
    </section>

    <footer class="bg-dark text-white py-3">
        <div class="container text-center">
            <p>All rights reserved © 2024 Book Store</p>
        </div>
    </footer>

    <!-- login form -->

    <div class="logInForm" id="logInForm">
        <div class="logInForm-header">
            <div class="tilte">
                <button data-close-button class="close-button closeLoginButton">&times;</button>
            </div>
        </div>
        <div class="logInForm-body">
            <h2>Welcome</h2>

            <form id="logForm">
                <h5>Log in:</h5>
                <div class="form-group userNameDiv">
                    <label for="userName"><span>★ </span>Enter user name:</label>
                    <input type="text" class="form-control" name="userName" id="userName" placeholder="user name" required />
                </div>
                <div class="form-group">
                    <label for="userEmail"><span>★ </span>Enter email:</label>
                    <input type="text" class="form-control" name="userEmail" id="userEmail" placeholder="email" required />
                </div>
                <div class="form-group">
                    <label for="userPassword"><span>★ </span>Enter password:</label>
                    <input type="password" class="form-control" name="userPassword" id="userPassword" placeholder="Password" required />
                </div>

                <input type="submit" value="Log in" class="btn" id="logInButton" />
                <input type="submit" value="Sign Up" class="btn" id="signupButton" />

                <div class="signupQuestion"><span>Not registered yet?  </span><a class="signup">signup</a></div>
                <div class="loginQuestion"><span>Already registered?  </span><a class="login">login</a></div>

            </form>
            <div class="google-login">
                <button class="gsi-material-button" onclick="oauthSignIn()">
                    <div class="gsi-material-button-state"></div>
                    <div class="gsi-material-button-content-wrapper">
                        <div class="gsi-material-button-icon">
                            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" style="display: block;">
                                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                                <path fill="none" d="M0 0h48v48H0z"></path>
                            </svg>
                        </div>
                        <span class="gsi-material-button-contents">Sign in with Google</span>
                        <span style="display: none;">Sign in with Google</span>
                    </div>
                </button>
            </div>
        </div>
    </div>
    <div id="overlay" class=""></div>
    <div id="loader-wrapper">
        <div id="loader"></div>
    </div>
    <!---------------->
    <!--book quiz-->
    <div id="quiz-container">
        <div class="quiz-header">
            <button data-close-button class="close-button closeQuizButton">&times;</button>
            <br />
            <h1 class="text-center text-dark">Books Quiz</h1>
        </div>
        <h5 class="timer"></h5>
        <div class="quis-instruction">
            <h4 class="text-center pink">Instructions:</h4>
            <pre>
                1.dsfsfsdfsefsef
                2.sdfsdfsdfsdfsdcd
                3.sdfsdfsdfsdfsdcd 
                4.sdfsdfsdfsdfsdcd 
                </pre>
        </div>
        <div id="questionContainer"></div>
        <div id="resultContainer"></div>
        <button class="btn btn-outline-dark btn-block pinkB start-quiz">Start Quiz</button>
        <div class='btn-next-back'>
            <button class='btn btn-outline-dark pinkB btn-back'>Back</button>
            <button class='btn btn-outline-dark pinkB btn-next'>Next</button>
        </div>
        <div class="end-quiz"></div>
    </div>
    <!---------------->
    <!-- book info -->
    <div id="book-info-container">
        <div class="book-info-header">
            <button data-close-button class="close-button closeBookInfoButton" onclick="closeBookInfo()">&times;</button>
            <br />
            <img class="book-info-img" />
            <h2 class="text-center book-info-title"></h2>
            <hr class="top-line" />
            <span class="bold white">Author: </span>
            <span class="book-info-author pink"></span>
            <span class="bold white">published: </span>
            <span class="book-info-publish pink"></span><br />
            <span class="book-info-rating pink"></span>
            <hr class="bot-line" />
        </div>
        <span class="white bold info">Info:</span><br />
        <br />
        <div id="book-info-body">
            <span class="white">Publish date: </span>
            <span class="pink book-info-publish right"></span>
            <span class="white">Author:</span>
            <span class="pink book-info-author right"></span>
            <span class="white">Category: </span>
            <span class="pink book-info-category right"></span>
            <span class="white">Pages: </span>
            <span class="pink book-info-numOfPages right"></span>
            <span class="white">Format: </span>
            <span class="pink book-info-format right"></span>
            <span class="white">Language: </span>
            <span class="pink book-info-lang right"></span>
        </div>
        <div class="buy-the-book"></div>
        <div class="book-info-reviews">
            <div id="carouselExampleControls" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner" id="review-carosel">
                </div>
                <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>
    </div>

    <!---------------->

    <script src="quiz.js"></script>
    <script>
        var usersAPI = "https://localhost:7225/api/IUsers";
        var booksAPI = "https://localhost:7225/api/Books";
        const rating = stars => '★★★★★☆☆☆☆☆'.slice(5 - stars, 10 - stars);

        var allBooks = [];
        let booksDict = {};
        var top5Books = [];

        var currentBookId;

        $(document).ready(function () {

            checkUserLogoutReason();
            checkForLoginUser();

            showBooks();

            // log in or sign up forms
            $('.login').click(showLoginForm);
            $('.signup').click(showSignupForm);

            // close form
            $('.closeLoginButton').click(closeLoginForm);

            // submit form
            $('#logInButton').click(loginUser);
            $('#signupButton').click(signupNewUser);

            // logout user
            $('.logout').click(logoutUser);

            //search book by title / author / text
            $(".search-book-btn").click(searchBook);

            $('.reset-search-book').click(showBooks);
            $('.reset-search-book').hide();
        })
        // page load animation
        window.addEventListener('load', function () {
            const blobs = document.querySelectorAll('.bubble-head');
            blobs.forEach(blob => {
                blob.style.animationPlayState = 'running'; // Trigger animation on load
            });
        });
        window.addEventListener('load', function () {
            const blobs = document.querySelectorAll('.bubble-head-left-s');
            blobs.forEach(blob => {
                blob.style.animationPlayState = 'running'; // Trigger animation on load
            });
        });

        // text to speach -> search bar : work on Google chrom / Opera / Samsung Internet

        const transcript = document.querySelector(".search-string");

        // Select the SVG element by its class and add a click event listener
        document.querySelector('.speech-to-text').addEventListener('click', () => {
            // Start speech recognition logic here
            transcript.value = "";  // Clear input field

            recognition = new webkitSpeechRecognition();  // Initialize speech recognition

            // Set up speech recognition options
            recognition.lang = "en-US";
            recognition.interimResults = false;
            recognition.continuous = false;
            recognition.maxAlternatives = 10;

            recognition.start();  // Start speech recognition

            // Handle the results of speech recognition
            recognition.onresult = (event) => {
                let text = "";
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i][0].confidence > 0.8) {
                        text += event.results[i][0].transcript;
                    }
                }

                transcript.value = text.trim();  // Update input field with transcribed text
            };

            recognition.onend = () => {
                // Re-enable recognition or handle when recognition ends
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                recognition.stop();
            };
        });

        //-----------------------

        // login with google 
        const clientId = "330257384068-acpk14o95tj991u9u5l9vngpmll1c38g.apps.googleusercontent.com"; // Your Client ID
        const redirectUri = "http://localhost:65055/HTMLPage1.html"; // Replace with your actual redirect URI

        /*
        * Create form to request access token from Google's OAuth 2.0 server.
        */
        function oauthSignIn() {
            // Google's OAuth 2.0 endpoint for requesting an access token
            var oauth2Endpoint = 'https://accounts.google.com/o/oauth2/v2/auth';

            // Create <form> element to submit parameters to OAuth 2.0 endpoint.
            var form = document.createElement('form');
            form.setAttribute('method', 'GET'); // Send as a GET request.
            form.setAttribute('action', oauth2Endpoint);

            // Parameters to pass to OAuth 2.0 endpoint.
            var params = {
                'client_id': clientId,
                'redirect_uri': redirectUri,
                'response_type': 'token',
                'scope': 'email',
                'include_granted_scopes': 'true',
                'state': ''
            };

            // Add form parameters as hidden input values.
            for (var p in params) {
                var input = document.createElement('input');
                input.setAttribute('type', 'hidden');
                input.setAttribute('name', p);
                input.setAttribute('value', params[p]);
                form.appendChild(input);
            }

            // Add form to page and submit it to open the OAuth 2.0 endpoint.
            document.body.appendChild(form);
            form.submit();
        }

        var accessToken = null;

        const hash = window.location.hash.substring(1);

        // Parse the hash into a query string format
        const params = new URLSearchParams(hash);

        // Retrieve the access token
        accessToken = params.get('access_token');

        if (accessToken) { trySampleRequest(); }


        function trySampleRequest() {

            if (accessToken) {

                var xhr = new XMLHttpRequest();
                xhr.open('GET',
                    'https://www.googleapis.com/oauth2/v2/userinfo?fields=email&' +
                    'access_token=' + accessToken);
                xhr.onreadystatechange = function (e) {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var userEmail = JSON.parse(xhr.response).email;
                        console.log(userEmail.email)
                        let user = {
                            "id": 0,
                            "userName": userEmail.split('@')[0],
                            "eMail": userEmail,
                            "password": "123",
                            "isAdmin": false,
                            "isActive": true,
                            "isLogIn": true
                        }
                        ajaxCall("PUT", usersAPI + '/loginGoogleUser', JSON.stringify(user), successLogin, error);

                    } else if (xhr.status === 401) {
                        // Token invalid, so prompt for user permission.
                        oauth2SignIn();
                    }
                };
                xhr.send(null);
            } else {
                oauth2SignIn();
            }
        }

        // book info

        function showBookInfo(bookId) {

            const buyer = JSON.parse(localStorage.getItem("loginUserDetails"));

            ajaxCall("GET", booksAPI +`/getBookReviews?bookId=${bookId}`, null, seccessToLoadReviews, errorR)

            let book = allBooks.find((book) => book.Id === bookId);

            $('#book-info-container').addClass('active');
            $('#overlay').addClass('active');
            $('.book-info-img').attr('src', book.Thumbnail);
            $('.book-info-title').html(book.Title);
            $('.book-info-rating').html( rating(book.Rating) + "   " + (book.Rating).toFixed(1));
            $('.book-info-author').html(book.FirstAuthorName);
            $('.book-info-publish').html(book.PublishDate);
            $('.book-info-category').html(book.Category);
            $('.book-info-numOfPages').html(book.NumOfPages);

            if (buyer != null) {
                const buyerId = buyer.userId;

                // If someone already bought the book
                if (book.IsAvailable == 0) {
                    if (book.UserId == buyerId) { // The logged-in user bought this book
                        $('.buy-the-book').html(`<a class='btn buyABookBtn pinkB ' id='notAllowed' disabled><s>Buy</s></a>`);

                    } else {
                        const userName = book.UserName ? book.UserName.toString() : ''; // Ensure userName exists and convert it to a string
                        $('.buy-the-book').html(`<a class='btn btn-outline-dark pinkB'  onclick='sendRequest(${buyerId}, ${book.UserId}, ${book.Id}, "${userName}")'>Buy</a>`);
                    }
                } else {
                    // If the book is available for purchase
                    $('.buy-the-book').html(`<a class='btn btn-outline-dark pinkB'  onclick='buyABook(${book.Id})'>Buy</a>`);
                }
            } else {
                // If the user is not logged in, there's no need to show the purchase option
                $('.buy-the-book').html(`<a class='btn btn-outline-dark pinkB'  onclick='buyABook(${book.Id})'>Buy</a>`);
            }

            if (book.IsEbook == 0) { $('.book-info-format').html('Hard Cover'); }
            else { $('.book-info-format').html('EBook'); }
            
            $('.book-info-lang').html('English');

        }
        function seccessToLoadReviews(reviews) {
            let html = '';
            let index = 1;
            
            if (reviews.length > 0) {
                reviews.forEach((review) => {
                    if (index++ == 1) {
                        html += `<div class="carousel-item active">
                        <div class='padding'>
                        <div class='book-review'>
                        <svg class='user-image-info' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512l388.6 0c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304l-91.4 0z"/></svg>
                                <h5 class='review-user'>${review.UserName}</h5>
                                <h5 class='review-rating pink'>${rating(review.Rating)}  ${(review.Rating).toFixed(1)}</h5>
                                <p class='review-text'>${review.Review}</p>
                                </div>
                                </div>
                                </div>`;
                    }
                    else {
                        html += `<div class="carousel-item">
                        <div class='padding'>
                                <div class='book-review'>
                                <svg class='user-image-info' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.--><path d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512l388.6 0c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304l-91.4 0z"/></svg>
                                <h5 class='review-user'>${review.UserName}</h5>
                                <h5 class='review-rating'>${rating(review.Rating)}  ${(review.Rating).toFixed(1)}</h5>
                                <p class='review-text'>${review.Review}</p>
                                </div>
                                </div>
                                </div>`;
                    }
                    
                })
                $('#review-carosel').html(html);
            }
        }

        function errorR(err) { console.log(err) }

        function closeBookInfo() {
            $('#book-info-container').removeClass('active');
            $('#overlay').removeClass('active');
            $('#review-carosel').html("");
        }

        // login or signup form

        function showLoginForm() {
            $('#logInForm').addClass('active');
            $('#overlay').addClass('active');
            $('.loginQuestion').hide();
            $('.signupQuestion').show();
            $('.userNameDiv').hide();
            $('#signupButton').hide();
            $('#logInButton').show();
        }
        function closeLoginForm() {
            $('#logInForm').removeClass('active');
            $('#overlay').removeClass('active');
        }
        function showSignupForm() {
            $('.userNameDiv').show();
            $('#signupButton').show();
            $('.loginQuestion').show();
            $('#logInButton').hide();
            $('.signupQuestion').hide();
        }

        // login user

        function loginUser() {

            var regexEmail = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;

            var userEmail = $('#userEmail').val();
            var userPassword = $('#userPassword').val();

            // check email and password in the correct format
            if (regexEmail.test(userEmail) && userPassword.length >= 3) {

                let user = {
                    "id": 0,
                    "userName": "",
                    "eMail": userEmail,
                    "password": userPassword,
                    "isAdmin": false,
                    "isActive": true,
                    "isLogIn": true
                }

                ajaxCall("PUT", usersAPI + '/loginUser', JSON.stringify(user), successLogin, error);
            }
            else {
                Swal.fire({
                    title: "Invalide email or password",
                    text: "Please check email in the correct format & password is more than 2 digits."
                });
            }

            return false;
        }

        function successLogin(userDetails) {

            localStorage.setItem("loginUserDetails", JSON.stringify(userDetails));

            checkForLoginUser();

            showBooks();

            closeLoginForm();
        }

        function error(errorMassage) { Swal.fire("Incorrect email or password"); }


        // signup new user

        function signupNewUser() {

            var regexEmail = /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/;

            var userEmail = $('#userEmail').val();
            var userPassword = $('#userPassword').val();
            var userName = $('#userName').val();

            if (userName == "") { Swal.fire("Please enter a user name"); return; }

            // check email and password in the correct format
            if (regexEmail.test(userEmail) && userPassword.length >= 3) {

                let newUser = {
                    "id": 0,
                    "userName": userName,
                    "eMail": userEmail,
                    "password": userPassword,
                    "isAdmin": false,
                    "isActive": true,
                    "isLogIn": true
                }

                ajaxCall("POST", usersAPI + "/signUpNewUser", JSON.stringify(newUser), successLogin, errorSignup)
            }
            else {
                Swal.fire({
                    title: "Invalide email or password",
                    text: "Please check email in the correct format & password is more than 2 digits."
                });
            }

            return false;
        }

        function errorSignup(errorMassage) { console.log(errorMassage); }

        function showMyBooks() { }

        // show books


        function showBooks() {

            if (allBooks.length == 0) {
                ajaxCall("GET", booksAPI, null, showAllBooks, errorToLoadBooks);

            }
            else { BooksToShow(allBooks, 'allBooks'); }

            getTop5Books();
        }

        function showAllBooks(books) {
            allBooks = books;
            activateSreachBooksBar();
            BooksToShow(allBooks, 'allBooks');
        }

        function getTop5Books() {
            if (top5Books.length == 0) {
                ajaxCall("GET", booksAPI + '/showTop5BooksByRating', null, top5booksByRating, errorToLoadBooks);
            }
            else { showTop5Books(top5Books); }
        }

        function top5booksByRating(topBooks) {
            top5Books = topBooks;
            showTop5Books(top5Books);
        }
        function showTop5Books(books, container) {
            let html = "";
            let index = 0;

            books.forEach((book) => {

                if (index++ == 0) {

                    html += ` <div class='carousel-item active '>
                            <div class='container'>
                                    <div class='top-books-container row'>
                                    <div class='col-md-5 col-xs-6'>
                                        <!--star-->
                                        <div class="top5-logo">
                                        <div class="star">
                                         <span class="top-5-star">Top 5</span>
                                      </div>
                                      </div>
                                    <img class='d-block  top-5-img'  alt='First slide' src='${book.Thumbnail}'>
                                    </div>
                                    <div class='top-info col-md-7 col-xs-6'>
                                    <h2>${book.Title}</h2>
                                    <h5 class='pink'>${rating(book.Rating)}  ${(book.Rating).toFixed(1)}</h5>
                                    <p>${limitStringLength(book.Description, 122)}</p>
                                    </div>
                                    </div>
                                    </div>
                                    </div >`;

                }

                else {
                    html += ` <div class='carousel-item  '>
                            <div class='container'>
                                    <div class='top-books-container row'>
                                    <div class='col-md-5 col-xs-6'>
                                        <!--star-->
                                        <div class="top5-logo">
                                        <div class="star">
                                         <span class="top-5-star">Top 5</span>
                                      </div>
                                      </div>
                                    <img class='d-block  top-5-img'  alt='First slide' src='${book.Thumbnail}'>
                                    </div>
                                    <div class='top-info col-md-7 col-xs-6'>
                                    <h2>${book.Title}</h2>
                                    <h5 class='pink'>${rating(book.Rating)}  ${(book.Rating).toFixed(1)}</h5>
                                    <p>${limitStringLength(book.Description, 122)}</p>
                                    </div>
                                    </div>
                                    </div>
                                    </div >`;
                }
            })
            $("#top5Books").html(html);
        }
        // limit the length of the string
        function limitStringLength(str, maxLength) {
            if (str.length > maxLength) {
                return str.slice(0, maxLength) + "...";
            } else {
                return str;
            }
        }

        function BooksToShow(books, containerId) {
            $('.reset-search-book').hide();

            allBooks = books;
            const BooksContainer = document.getElementById('allBooks');
            if (BooksContainer.classList.contains('container')) {
                // If it has the class 'row', remove 'row' and add 'container'
                BooksContainer.classList.remove('container');
                BooksContainer.classList.add('row');
            } 
            let booksHtml = '';
            const buyer = JSON.parse(localStorage.getItem("loginUserDetails"));

            books.forEach((book) => {
                if (book.IsActive == 1) {
                    booksHtml += `<a onclick='showBookInfo(${book.Id})'>
                                                    <div class='col-lg-3 col-sm-4 book-info'>`

                    if (buyer != null && book.IsAvailable == 0 && buyer.userId == book.UserId) { booksHtml += `<div class='card mb-4 book-card book-${book.Id} bought'>` }
                    else { booksHtml += `<div class='card mb-4 book-card book-${book.Id}'>` }

                    booksHtml +=                          `  <img src='${book.SmallThumbnail}' class='card-img-top' alt='Book'>
                                                            <div class='card-body w-100'>
                                                                <h6 class='card-title'>${book.Title}</h6>
                                                                <p id='pinkStars'>${rating(book.Rating)}  ${(book.Rating).toFixed(1)}</p>
                                                                <span class='card-text'>${book.Price}$       </span>`;

                    if (buyer != null) {
                        const buyerId = buyer.userId;

                        // If someone already bought the book
                        if (book.IsAvailable == 0) {
                            if (book.UserId == buyerId) { // The logged-in user bought this book
                                booksHtml += `<a class='btn buyABookBtn pinkB ' id='notAllowed' disabled><s>Buy</s></a>
                                                                          </div>
                                                                          </div>
                                                                          </div></a>`;
                            } else {
                                const userName = book.UserName ? book.UserName.toString() : ''; // Ensure userName exists and convert it to a string
                                booksHtml += `<a class='btn btn-outline-dark buyABookBtn pinkB' onclick='sendRequest(${buyerId}, ${book.UserId}, ${book.Id}, "${userName}")'>Buy</a>
                                                                          </div>
                                                                          </div>
                                                                          </div></a>`;
                            }
                        } else {
                            // If the book is available for purchase
                            booksHtml += `<a class='btn btn-outline-dark buyABookBtn pinkB' onclick='buyABook(${book.Id})'>Buy</a>
                                                                      </div>
                                                                      </div>
                                                                      </div></a>`;
                        }
                    } else {
                        // If the user is not logged in, there's no need to show the purchase option
                        booksHtml += `<a class='btn btn-outline-dark buyABookBtn pinkB' onclick='buyABook(${book.Id})'>Buy</a>
                                                                  </div>
                                                                  </div>
                                                                  </div></a>`;
                    }
                }
            });

            BooksContainer.innerHTML = booksHtml;
        }

        function errorToLoadBooks(message) { console.log(message); }

        // buy a book

        function buyABook(bookId) {

            currentBookId = bookId;

            var buyer = JSON.parse(localStorage.getItem("loginUserDetails"))

            if (buyer != null) {

                buyer = buyer.userId; // set the buyer id from the json

                ajaxCall("POST", usersAPI + '/addNewBookToUser?userId=' + buyer + '&bookId=' + bookId, null, successToBuyABook, errorBuyABook);
            }

            else { Swal.fire("Please login first"); }
        }

        function successToBuyABook(status) {
            Swal.fire('Success', "The book has been successfully purchased", 'success');
            closeBookInfo();
            $(`.book-${currentBookId}`).addClass('bought');
            setBooksDetails(allBooks);
            setBooksDetails(top5Books);

            showBooks();
        }

        function errorBuyABook(error) {
            if (error.status == 401) {

                Swal.fire("Connection time ended - Please login first");

                localStorage.clear();

                checkForLoginUser();

                showLoginForm();
            }
            else { Swal.fire("Error to buy a book"); }
        }
        // set the book details
        function setBooksDetails(books) {
            for (let i = 0; i < books.length; i++) {
                if (books[i].Id == currentBookId) {
                    books[i].IsAvailable = 0;
                    books[i].UserId = JSON.parse(localStorage.getItem("loginUserDetails")).userId;
                }
            }
        }
       

     
        //------------------------
        function activateSreachBooksBar() {

            allBooks.forEach((book) => {
                let text = book.Title + " " + book.FirstAuthorName + " " + book.SecondAuthorName + " " + book.TextSnippet + " " + book.Description;
                booksDict[JSON.stringify(book)] = text.toLowerCase();
            })
        }
        function searchBook() {
            let searchString = ($(".search-string").val()).toLowerCase();
            let bookList = []

            if (searchString == "") { }
            else {
                for (let key in booksDict) {

                    let index = booksDict[key].indexOf(searchString)

                    if (index != -1) {

                        let str = booksDict[key];
                        let section1 = str.substring(index - 50 - searchString.length, index);
                        let section2 = str.substring((index + searchString.length), (index + searchString.length + 200) );
                        let findSearchString = searchString

                        let book = JSON.parse(key);
                        book['foundString'] = `<p>...${section1}<strong class='pink'>${findSearchString}</strong>${section2}...</p>`;
                        bookList.push(book);

                    }
                }
                if (bookList.length == 0) {
                    document.getElementById("allBooks").innerHTML = "<h5>0 books was found...</h5>";
                }
                else {
                    const BooksContainer = document.getElementById('allBooks');
                    if (BooksContainer.classList.contains('row')) {
                        // If it has the class 'row', remove 'row' and add 'container'
                        BooksContainer.classList.remove('row');
                        BooksContainer.classList.add('container');
                    } 
                    const buyer = JSON.parse(localStorage.getItem("loginUserDetails"));
                    let booksHtml = '';

                    bookList.forEach((book) => {
                        booksHtml += `
                                                    <div class='row'>
                                                        <div class=' mb-4 book-card-search col-xl-2 col-lg-3 col-md-4 col-12'>
                                                            <img src='${book.SmallThumbnail}' class='card-img-search' alt='Book'>
                                                            </div>
                                                            <div class='card-body w-100 col-xl-10 col-lg-9 col-md-8 col-12'>
                                                                <h3 class='card-title'>${book.Title}</h3>
                                                                ${book.foundString}
                                                                <p id='pinkStars'>${rating(book.Rating)}  ${(book.Rating).toFixed(1)}</p>
                                                                <span class='card-text'>${book.Price}$       </span>`;
                        if (buyer != null) {
                            const buyerId = buyer.userId;

                            // If someone already bought the book
                            if (book.IsAvailable == 0) {
                                if (book.UserId == buyerId) { // The logged-in user bought this book
                                    booksHtml += ` <a class='btn buyABookBtn pinkB ' id = 'notAllowed' disabled > <s>Buy</s></a >
                                                                          </div>
                                                                          </div>`;
                                } else {
                                    const userName = book.UserName ? book.UserName.toString() : ''; // Ensure userName exists and convert it to a string
                                    booksHtml += `<a class='btn btn-outline-dark buyABookBtn pinkB' onclick='showBookInfo(${book.Id})'>Info</a>
                                                                      </div>
                                                                      </div>
                                                                      </div>`;
                                }
                            } else {
                                // If the book is available for purchase
                                booksHtml += `<a class='btn btn-outline-dark buyABookBtn pinkB' onclick='showBookInfo(${book.Id})'>Info</a>
                                                                      </div>
                                                                      </div>
                                                                      </div>`;
                            }
                        } else {
                            // If the user is not logged in, there's no need to show the purchase option
                            booksHtml += `<a class='btn btn-outline-dark buyABookBtn pinkB' onclick='showBookInfo(${book.Id})'>Info</a>
                                                                        </div>
                                                                      </div>
                                                                      </div>`;
                        }
                    });
                    BooksContainer.innerHTML = booksHtml;
                }
                $('.reset-search-book').show();
            }
            return false;
        }

    </script>
    <!-- shared function -->
    <script src="sharedFunc.js"></script>
</body>
</html>
